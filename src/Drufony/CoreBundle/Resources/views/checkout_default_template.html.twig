{# For theming customization #}
{% form_theme form 'DrufonyCoreBundle::form_theme_checkout.html.twig' %}

<!-- page title -->
<h1 class="page-title hidden">{{'Checkout' |t}} </h1>
<!--/ page title -->

<div class="checkout-process-wrapper">

{% set step = 1 %}

{# Checkout Method #}
<section id="login_sect" class="checkout">
  {% if userLogged != true %}
      {% set step = step + 1 %}
      {% if checkoutStep == 'checkoutMethod' %}
	 <div class="wd90">
	     <div class="pad15">
			{{ "Login to quick buy or"|t }} <a class="underline" href='{{ path('drufony_checkout_without_login', { 'lang' : lang, 'withoutlogin': true})}}'">{{ "continue without login" | t }}</a>
	    </div>	
	    <div class="wd40 center">
            {{ form_start(loginForm) }}
            {{ form_errors(loginForm) }}
              <label class="label" style="margin-bottom:10px">
                {{ form_label(loginForm.username) }}
                {% if loginForm.username.vars.required %}
                  <span>*</span>
                {% endif %}
              </label>
              {{ form_errors(loginForm.username) }}
              <label class="input" style="margin-bottom:18px">
                {{ form_widget(loginForm.username, { 'attr': { 'class': 'form-control' } }) }}
              </label>
              <label class="label" style="margin-bottom:10px">
                {{ form_label(loginForm.password) }}
                {% if loginForm.password.vars.required %}
                  <span>*</span>
                {% endif %}
              </label>
              {{ form_errors(loginForm.password) }}
              <label class="input" style="margin-bottom:18px">
                {{ form_widget(loginForm.password, { 'attr': { 'class': 'form-control' } }) }}
              </label>
              {{ form_errors(loginForm.rememberme) }}
              {{ form_widget(loginForm.rememberme) }}
              <div>
                {{ form_row(loginForm.login, {'attr': {'class': 'button button-ok'}} ) }}
              </div>
            {{ form_end(loginForm) }}
		<div class="pad15">
                <a class="underline" href="{{ path('drufony_user_request_forgot_pass', {'lang' : lang }) }}">{{ "Forgot password?" | t }}</a>
		</div>
	</div>
      {% else  %}
        <div class="wd90">
          <a href='{{ path('drufony_checkout_login', { 'lang' : lang})}}'>
          	<h2>{{'Login'|t}}</h2>
          </a>
        </div>
      {% endif %}
  {% else %}
        <div class="wd90">
          <a href='{{ path('drufony_checkout_login', { 'lang' : lang})}}'>
            <h2>{{'Logged'|t}}</h2>
          </a>
        </div>
    {% set step = step + 1 %}
  {% endif %}
</section>


{# Shipping Information #}
<section id="shipping_sect" class="checkout wd90">
  {% if checkoutStep == 'shippingInformation' %}
    {% set step = step + 1 %}
    <div id="target"></div>
    <div class="wd90">
      <h2>Shipping information</h2>
      	<div>
	{{ form_start(form, {'attr': { 'id': 'paymentForm', 'class': 'form' } }) }}
      {% include 'DrufonyCoreBundle::checkout_shipping_info.html.twig' %}
      {{ form_end(form) }}
      </div>
    </div>
  {% else %}
    {% set step = step + 1 %}
    <div class="wd90">
      {% if checkoutMethodCompleted %}
      <a href='{{ path('drufony_checkout_shipping_info', { 'lang' : lang})}}'>
        <h2>Shipping information</h2>
      </a>
      {% else %}
        <h2>Shipping information</h2>
      {% endif %}
    </div>
  {% endif %}
</section>

{# Billing Information #}
<section id="billing_sect" class="checkout wd90">
  {% if checkoutStep == 'billingInformation' %}
    <div id="target"></div>
    <div class="wd90">
      <h2>Billing Information</h2>
      <div>
	{{ form_start(form, {'attr': { 'id': 'paymentForm', 'class': 'form' } }) }}
      {% include 'DrufonyCoreBundle::checkout_billing_info.html.twig' %}
      {{ form_end(form) }}
      </div>
    </div>
  {% else %}
    <div class="wd90">
      {% if checkoutMethodCompleted %}
      <div> 
      <a href='{{ path('drufony_checkout_billing_info', { 'lang' : lang})}}'>
        <h2>Billing Information</h2>
      </a>
      {% else %}
        <h2>Billing Information</h2>
      {% endif %}
    </div>
    </div>
  {% endif %}
 </section>

{# Shipping Method #}
<section id="shipping_methos_sect" class="checkout wd90">
  {% if checkoutStep == 'shippingMethod' %}
    {% set step = step + 1 %}
    <div id="target"></div>
    <div class="wd90">
      <h2>{{'Order Summary'|t}}</h2>
    	<div class="bb">	
      		{{ form_start(form, {'attr': { 'id': 'paymentForm', 'class': 'form' } }) }}
      		{% include 'DrufonyCoreBundle::checkout_shipping_method.html.twig' %}
      		{{ form_end(form) }}
    	</div>
    </div>
  {% else %}
    {% set step = step + 1 %}
    <div class="wd90">
      {% if checkoutMethodCompleted %}
      <a href='{{ path('drufony_checkout_shipping_method', { 'lang' : lang})}}'>
        <h2>{{'Order Summary'|t}}</h2>
      </a>
      {% else %}
        <h2>{{'Order Summary'|t}}</h2>
      {% endif %}
    </div>
  {% endif %}
</section>

{# Payment Method #}
<section id="payment_sect" class="checkout wd90" style="margin-bottom:18px">
  {% if checkoutStep == 'selectPaymentMethod' %}
    {% set step = step + 1 %}
    <div id="target"></div>
    <div class="wd90">
      <h2>Payment method</h2>
      <form id='payment_options' action="{{ path('drufony_checkout_review_payment', {'lang' : lang} ) }}" method="post">
	{% if data is defined %}
	<input type="hidden" name="Ds_Merchant_Amount" value="{{  data.predefined_data.sermepa_express_checkout.Amount}}" />
	<input type="hidden" name="Ds_Merchant_Currency" value="{{data.predefined_data.sermepa_express_checkout.currency}}" />
	<input type="hidden" name="Ds_Merchant_Order" value="{{data.predefined_data.sermepa_express_checkout.Order_Number}}" />
	<input type="hidden" name="Ds_Merchant_MerchantData" value="{{data.predefined_data.sermepa_express_checkout.Merchant_Data}}" />
	<input type="hidden" name="Ds_Merchant_MerchantCode" value="{{data.predefined_data.sermepa_express_checkout.Merchant_Code}}" />
	<input type="hidden" name="Ds_Merchant_Terminal" value="{{data.predefined_data.sermepa_express_checkout.Terminal}}" />
	<input type="hidden" name="Ds_Merchant_TransactionType" value="{{data.predefined_data.sermepa_express_checkout.Transaction_Type}}" />
	<input type="hidden" name="Ds_Merchant_MerchantURL" value="{{data.predefined_data.sermepa_express_checkout.return_url}}" />
	<input type="hidden" name="Ds_Merchant_MerchantSignature" value="{{data.predefined_data.sermepa_express_checkout.Merchant_Signature}}" /> 
	<input type="hidden" name="Ds_Merchant_UrlOK" value="{{data.predefined_data.sermepa_express_checkout.return_url_ok}}" /> 
	{% endif %}
        
        <div class="wd30 center">
	{{ form_widget(form.method) }}

	</div>
	
        <div class="wd90 center">

        {{ form_widget(form.send, {'attr': {'class': 'button button-ok mg-bottom15'}} ) }}
	{{ form_rest(form) }}	

	</div>

    </form>
</div>
  {% else %}
    {% set step = step + 1 %}
    <div class="wd90">
      {% if checkoutMethodCompleted %}
      <a href='{{ path('drufony_checkout_review_payment', { 'lang' : lang})}}'>
        <h2>Payment method</h2>
      </a>
      {% else %}
        <h2>Payment method</h2>
      {% endif %}
    </div>
  {% endif %}
</section>


</div>
<div style="clear:both"></div>
{% if data is defined %}
<script type="text/javascript">
history.navigationMode = 'compatible';
$(document).ready(function(){
	alert("sometext");
	$("#payment_options").submit(function(e) {		
		e.preventDefault();
    		url = "{{ path('drufony_checkout_review_payment', { 'lang' : lang})}}";
		var checked_site_radio = $("#jms_choose_payment_method_method_1:checked").val();
		if(checked_site_radio=='sermepa_express_checkout'){
			url = "{{data.predefined_data.sermepa_express_checkout.send_url}}";
		}
		form = $(this);
		alert(form.serialize()); 
		form.attr('action' ,url); //give it the action url ); 
           	form.unbind('submit').submit(); //submit it...
	
	});



});
</script>
{% endif %}

